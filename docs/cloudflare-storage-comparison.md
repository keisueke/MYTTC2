# Cloudflare データストレージ比較検討

## 概要

GitHub APIからCloudflareへの移行において、最適なデータストレージを選択するための比較検討ドキュメントです。

## 比較対象

### Cloudflare D1（SQLite）

**特徴**:
- SQLiteベースのリレーショナルデータベース
- SQLクエリが使用可能
- トランザクション対応
- 外部キー制約サポート

**無料プランの制限**:
- **ストレージ**: 5GB
- **読み取り**: 100,000行/日
- **書き込み**: 1,000行/日
- **データベース数**: 制限なし

**料金**:
- 無料プラン: 上記の制限内
- 有料プラン: $0.001/GB/月（ストレージ）、$0.001/百万行（読み取り）、$1.00/百万行（書き込み）

**メリット**:
- リレーショナルデータに適している
- 複雑なクエリが可能
- データ整合性の保証（外部キー制約）
- トランザクション処理が可能
- 既存のSQL知識を活用できる

**デメリット**:
- 書き込み制限が厳しい（1,000行/日）
- 読み取りも制限あり（100,000行/日）
- スキーマ変更にマイグレーションが必要

### Cloudflare KV（Key-Value）

**特徴**:
- グローバルに分散されたKey-Valueストレージ
- 低レイテンシー
- 最終的な整合性（Eventual Consistency）

**無料プランの制限**:
- **読み取り**: 100,000回/日
- **書き込み**: 1,000回/日
- **削除**: 1,000回/日
- **ストレージ**: 1GB
- **キー数**: 制限なし

**料金**:
- 無料プラン: 上記の制限内
- 有料プラン: $0.50/百万読み取り、$5.00/百万書き込み、$0.50/GB/月（ストレージ）

**メリット**:
- 非常に高速（低レイテンシー）
- グローバルに分散
- シンプルなデータ構造に適している
- スキーマレス

**デメリット**:
- リレーショナルデータには不向き
- 複雑なクエリができない
- トランザクション非対応
- 最終的な整合性（即座の整合性は保証されない）

## 本アプリケーションの要件

### データ構造
- **リレーショナルデータ**: タスク、プロジェクト、モード、タグなどが関連
- **複雑なクエリ**: 日付範囲でのフィルタリング、関連データの結合
- **データ整合性**: 外部キー制約が必要（例: routine_executions → tasks）

### 使用パターン
- **読み取り**: タスク一覧表示、統計計算（頻繁）
- **書き込み**: タスク作成・更新、ルーティン実行記録（中程度）
- **同期**: 複数デバイス間でのデータ同期

### データ量の見積もり
- **タスク**: 1,000件程度（1件あたり約1KB）→ 約1MB
- **ルーティン実行記録**: 365日 × 10タスク = 3,650件（1件あたり約500B）→ 約2MB
- **日次記録**: 365日 × 1件（1件あたり約1KB）→ 約365KB
- **その他**: プロジェクト、モード、タグ、目標など → 約1MB
- **合計**: 約5MB（無料プランの制限内）

### 読み書き頻度の見積もり
- **1日の読み取り**: タスク一覧表示（10回）、統計計算（5回）、詳細表示（20回）→ 約35回/日
- **1日の書き込み**: タスク作成・更新（10回）、ルーティン実行記録（10回）、日次記録（1回）→ 約21回/日
- **月間**: 読み取り約1,050回、書き込み約630回（無料プランの制限内）

## 推奨: Cloudflare D1

### 理由

1. **リレーショナルデータ構造**
   - タスク、プロジェクト、モード、タグなどが関連している
   - 外部キー制約でデータ整合性を保証できる
   - 複雑なJOINクエリが可能

2. **クエリの柔軟性**
   - 日付範囲でのフィルタリング
   - 統計計算（集計関数）
   - ソート、グループ化

3. **トランザクション処理**
   - データ同期時の整合性保証
   - 複数テーブルへの同時書き込み

4. **無料プランで十分**
   - ストレージ: 5GB（現在のデータ量は約5MB）
   - 読み取り: 100,000行/日（見積もり: 約1,050回/日）
   - 書き込み: 1,000行/日（見積もり: 約630回/日）

5. **将来の拡張性**
   - データ量が増えても対応可能
   - 有料プランへの移行が容易

### 注意点

1. **書き込み制限**
   - 1,000行/日の制限があるため、バッチ処理を検討
   - 不要な書き込みを避ける（更新が必要な場合のみ）

2. **読み取り最適化**
   - インデックスの適切な設定
   - キャッシュ戦略の検討

3. **マイグレーション**
   - スキーマ変更時はマイグレーションが必要
   - バージョン管理が重要

## 実装方針

### フェーズ1: D1の採用
- Cloudflare D1を使用してデータストレージを実装
- スキーマ設計とマイグレーション準備

### フェーズ2: 最適化
- 読み書き頻度の監視
- 必要に応じてキャッシュ戦略の実装
- バッチ処理の検討

### フェーズ3: 拡張（必要に応じて）
- データ量が増えた場合の有料プランへの移行検討
- KVを補助的に使用する可能性（キャッシュなど）

## 結論

**Cloudflare D1を採用**します。

理由:
- リレーショナルデータ構造に適している
- 無料プランの制限内で十分
- 将来の拡張性がある
- データ整合性を保証できる

KVは、将来的にキャッシュ層として使用する可能性はありますが、主要なデータストレージとしてはD1が最適です。

