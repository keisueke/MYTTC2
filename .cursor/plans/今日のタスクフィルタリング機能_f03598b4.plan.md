---
name: 今日のタスクフィルタリング機能
overview: 「今日のタスク」ページで、本日作業予定のタスクのみを表示するようにフィルタリング機能を追加します。本日完了したタスクの表示/非表示は既存のチェックボックスで選択可能にします。
todos:
  - id: update-reflection-button
    content: DailyReflectionコンポーネントの生成ボタンを常に表示するように変更
    status: completed
---

# 今日のタスクフィルタリング機能

## 概要

「今日のタスク」ページで、本日作業予定のタスクのみを表示するようにフィルタリング機能を追加します。本日完了したタスクの表示/非表示は既存のチェックボックスで選択可能にします。

## 実装内容

### 1. タスクが今日のタスクかどうかを判定する関数

**ファイル**: `src/utils/repeatUtils.ts` または新しいユーティリティファイル

- `isTaskForToday(task: Task): boolean` 関数を追加
- 以下の条件のいずれかを満たすタスクを「今日のタスク」と判定：

        1. 今日作成されたタスク（`createdAt`が今日の日付）
        2. 今日が期限日のタスク（`dueDate`が今日の日付）
        3. 今日作業を開始したタスク（`startTime`が今日の日付）
        4. 繰り返しタスクで今日に該当するもの（既存の`isRepeatTaskForToday`を使用）
```typescript
import { Task } from '../types'
import { isRepeatTaskForToday } from './repeatUtils'

/**
 * タスクが今日のタスクかどうかを判定
 */
export function isTaskForToday(task: Task): boolean {
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  const todayEnd = new Date(today)
  todayEnd.setHours(23, 59, 59, 999)
  const todayStr = today.toISOString().split('T')[0]

  // 1. 今日作成されたタスク
  if (task.createdAt) {
    const createdDate = new Date(task.createdAt)
    if (createdDate >= today && createdDate <= todayEnd) {
      return true
    }
    // 日付文字列で比較（より確実）
    if (task.createdAt.startsWith(todayStr)) {
      return true
    }
  }

  // 2. 今日が期限日のタスク
  if (task.dueDate) {
    const dueDate = new Date(task.dueDate)
    dueDate.setHours(0, 0, 0, 0)
    if (dueDate.getTime() === today.getTime()) {
      return true
    }
    // 日付文字列で比較
    if (task.dueDate.startsWith(todayStr)) {
      return true
    }
  }

  // 3. 今日作業を開始したタスク
  if (task.startTime) {
    const startDate = new Date(task.startTime)
    if (startDate >= today && startDate <= todayEnd) {
      return true
    }
  }

  // 4. 繰り返しタスクで今日に該当するもの
  if (task.repeatPattern !== 'none') {
    return isRepeatTaskForToday(task)
  }

  return false
}
```


### 2. TaskListコンポーネントで今日のタスクをフィルタリング

**ファイル**: `src/components/tasks/TaskList.tsx`

- `filteredAndSortedTasks`の計算で、まず今日のタスクのみをフィルタリング
- その後、既存のプロジェクト/モード/タグフィルタを適用
- 完了済みタスクの表示/非表示は既存の`showCompleted`で制御
```typescript
import { isTaskForToday } from '../../utils/repeatUtils'

const filteredAndSortedTasks = useMemo(() => {
  // まず今日のタスクのみをフィルタリング
  let filtered = tasks.filter(task => isTaskForToday(task))
  
  // 完了したタスクのフィルタリング（既存のロジック）
  if (!showCompleted) {
    filtered = filtered.filter(t => !t.completedAt)
  }

  // 既存のプロジェクト/モード/タグフィルタを適用
  // ... 既存のコード ...
}, [tasks, projectFilter, modeFilter, tagFilter, sortBy, showCompleted])
```


### 3. 重複したuseEffectの削除

**ファイル**: `src/components/tasks/TaskList.tsx`

- 重複している`useEffect`を1つに統合
```typescript
// タスク一覧表示時に繰り返しタスクを生成
useEffect(() => {
  ensureTodayRepeatTasks()
}, [])
```


## 実装の詳細

### 「今日のタスク」の判定基準

1. **今日作成されたタスク**: `createdAt`が今日の日付
2. **今日が期限日のタスク**: `dueDate`が今日の日付
3. **今日作業を開始したタスク**: `startTime`が今日の日付
4. **繰り返しタスク**: `isRepeatTaskForToday`で判定

### 完了済みタスクの表示

- `showCompleted`チェックボックスで制御
- `showCompleted === true`: 今日のタスクのうち、完了済みも表示
- `showCompleted === false`: 今日のタスクのうち、未完了のみ表示

### フィルタリングの順序

1. 今日のタスクをフィルタリング
2. 完了済みタスクの表示/非表示を適用
3. プロジェクト/モード/タグフィルタを適用
4. ソートを適用

## 注意事項

- 繰り返しタスクは既に`ensureTodayRepeatTasks`で今日のインスタンスが生成されているため、`createdAt`が今日のタスクとして判定される
- 過去に作成されたタスクでも、今日が期限日または今日作業を開始した場合は表示される
- 他のページ（例：全タスク一覧）では影響しない