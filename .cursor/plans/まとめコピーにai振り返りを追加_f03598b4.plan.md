---
name: まとめコピーにAI振り返りを追加
overview: 「まとめをコピー」機能で、指定日付にAIからの振り返り（DailyReflection）が存在する場合、その内容（summary, insights, suggestions）をまとめに含めるようにします。
todos:
  - id: update-reflection-button
    content: DailyReflectionコンポーネントの生成ボタンを常に表示するように変更
    status: completed
---

# まとめコピーにAI振り返りを追加

## 概要

`generateTodaySummary`関数を更新し、指定日付にAIからの振り返り（DailyReflection）が存在する場合、その内容をまとめに含めます。

## 実装内容

### 1. `generateTodaySummary`関数の更新

**ファイル**: `src/utils/export.ts`

- `reflectionService.getReflectionByDate`をインポート
- 指定日付（または今日）の振り返りを取得
- 振り返りが存在する場合、以下のセクションをまとめに追加：
  - **AI振り返り**: summary, insights, suggestionsを含む
  - 日付形式は`YYYY-MM-DD`に変換して取得
```typescript
import { getReflectionByDate } from '../services/reflectionService'

// generateTodaySummary関数内で、タスク詳細の後に追加
// 振り返りの取得
const dateStr = format(date, 'yyyy-MM-dd', { locale: ja })
const reflection = getReflectionByDate(dateStr)

if (reflection) {
  markdown += `## AI振り返り\n\n`
  markdown += `### 要約\n${reflection.summary}\n\n`
  
  if (reflection.insights && reflection.insights.length > 0) {
    markdown += `### インサイト\n`
    reflection.insights.forEach(insight => {
      markdown += `- ${insight}\n`
    })
    markdown += `\n`
  }
  
  if (reflection.suggestions && reflection.suggestions.length > 0) {
    markdown += `### 改善提案\n`
    reflection.suggestions.forEach(suggestion => {
      markdown += `- ${suggestion}\n`
    })
    markdown += `\n`
  }
}
```


## 実装の詳細

### 日付形式の変換

- `generateTodaySummary`関数内で、`targetDate`または`new Date()`を`YYYY-MM-DD`形式に変換
- `date-fns`の`format`関数を使用: `format(date, 'yyyy-MM-dd', { locale: ja })`

### 振り返りセクションの配置

- 振り返りセクションは「タスク詳細」セクションの後に追加
- 振り返りが存在しない場合は、このセクションは表示しない

### フォーマット

- **要約**: `### 要約\n{summary}\n\n`
- **インサイト**: `### インサイト\n- {insight1}\n- {insight2}\n\n`
- **改善提案**: `### 改善提案\n- {suggestion1}\n- {suggestion2}\n\n`

## 注意事項

- 振り返りが存在しない場合は、このセクションを追加しない（既存の動作を維持）
- 日付形式の変換に注意（`YYYY-MM-DD`形式で取得）
- 既存のまとめの構造を維持しつつ、振り返りセクションを追加