---
name: 時間セクション設定とタスク連動
overview: 曜日ごとの時間セクション（朝・仕事・夜など）を設定し、タスクの時間帯と自動／手動で紐づけて並び替えや視認性を向上させます。
todos:
  - id: add-date-context
    content: SelectedDateContextの作成とApp全体へのプロバイダ適用
    status: completed
  - id: header-date-ui
    content: Headerでコンテキストの日付を表示し、前日/翌日ボタンを追加
    status: completed
    dependencies:
      - add-date-context
  - id: tasks-header-date
    content: Tasksページ見出しをselectedDate表示に変更
    status: completed
    dependencies:
      - add-date-context
  - id: task-date-filter-core
    content: isTaskForDateの追加とisTaskForTodayの薄いラッパー化
    status: completed
  - id: tasklist-reference-date
    content: TaskListにreferenceDateを渡してフィルタを選択日付対応に変更
    status: completed
    dependencies:
      - task-date-filter-core
  - id: tasks-wire-date
    content: TasksページからTaskListにselectedDateを渡すよう接続
    status: completed
    dependencies:
      - add-date-context
      - tasklist-reference-date
---

## 時間セクション機能 追加プラン

### 1. ドメインモデルと永続化の拡張

- `src/types/index.ts`
- `TimeSection` 型を追加（`id`, `name`, `start`, `end`, `color?` など）。
- `Weekday` 型（0–6 or `'mon' | ...'sun'`）と、曜日ごとの設定を持つ `TimeSectionDayConfig` / 全体をまとめる `TimeSectionSettings` を追加。
- `Task` に `timeSectionId?: string` を追加（自動判定 or 手動指定されたセクションIDを保持）。
- `AppData` に `timeSectionSettings?: TimeSectionSettings` を追加。
- `src/services/taskService.ts`
- `getTimeSectionSettings()` / `saveTimeSectionSettings()` を実装し、`AppData` に保存・読み書きする。
- 2〜5個のセクション制約と、同一曜日内での時間帯の重なりチェック（`start < end`、隣接・重複なし）をサーバ側（サービス層）でもバリデーション。
- `addTask` / `updateTask` 内にヘルパーを挿入し、
  - タスクに `startTime` または `dueDate` がある場合、そのローカル時間＋曜日から該当する `TimeSection` を検索し、`timeSectionId` を自動セット（ただし呼び出し側で既に `timeSectionId` が指定されている場合はそれを優先）。

### 2. 時間セクション判定ユーティリティ

- `src/utils/timeSectionUtils.ts`（新規）
- `getWeekday(date: Date): Weekday`（ローカル曜日取得）。
- `findSectionForDateTime(settings: TimeSectionSettings, date: Date): TimeSection | undefined`（指定日時が属するセクションを検索）。
- `findSectionForTask(task: Task, settings: TimeSectionSettings, baseDate: Date): TimeSection | undefined`（タスクの`startTime`/`dueDate`から時間帯を推定）。
- 既存のローカル時間ユーティリティ（`toLocalDateStr` など）と重複しないように整理し、必要なら共通化（`src/utils/dateUtils.ts` など）を検討。

### 3. 設定画面UI：曜日ごとのセクション編集

- `src/pages/Settings.tsx`
- 新セクション「時間セクション」を追加。
- 曜日タブ（または横並びのボタン）で `Mon〜Sun` を切り替え、それぞれ 2〜5 行のセクションを編集できるフォームを表示：
  - 入力項目: セクション名（例: 朝時間）、開始時刻(`HH:mm`), 終了時刻(`HH:mm`), カラー（任意）
  - セクション追加／削除ボタン（行数が2未満 or 5超の場合は無効化）
- フロント側でも時間帯の重なりと開始<終了をバリデーションし、エラー表示＋保存ボタン無効化。
- `getTimeSectionSettings()` で初期読込し、`saveTimeSectionSettings()` で保存。

### 4. タスクへのセクション設定と自動判定

- `src/components/tasks/TaskForm.tsx`
- フォーム下部に「時間セクション」フィールドを追加：
  - プルダウン: 「自動判定」「朝時間」「仕事」「夜」など、現在選択中の日付の曜日に対応するセクション一覧。
  - デフォルトは「自動判定」（`timeSectionId` 未設定）。
- 既存の `startTime`/`dueDate` 入力と連動し、ユーザーが「自動判定」のままならプレビュー表示用に推定セクション名を表示（保存時にサービス側で最終的に決定）。
- 既存タスク編集時は、保存済み `timeSectionId` を選択状態で表示。

### 5. タスクリストでの並び替え・表示拡張

- `src/components/tasks/TaskList.tsx`
- `SortType` に `'timeSection'` を追加し、「並び替え」プルダウンに「時間セクション順」を追加。
- ソートロジック：

  1. `timeSectionId` のあるタスクを、曜日設定中のセクション順（start 時刻の昇順）で並べる。
  2. `timeSectionId` がないタスクは末尾にまとめる（または「その他」扱い）。
  3. 同一セクション内は `createdAt` か `startTime` でソート。

- `referenceDate` と `TimeSectionSettings` を組み合わせて、その日の曜日に対応するセクション順を取得するヘルパーを利用。
- `src/components/tasks/TaskItem.tsx`
- セクション名バッジをタイトルの横などに表示（例: 「[朝時間] 夕食」）。
- バッジカラーに `TimeSection.color` を利用（なければデフォルトカラー）。

### 6. 時間セクションと他機能との連携（最低限）

- `src/components/dashboard/HabitTracker.tsx` / `src/pages/Analyze.tsx` などで、将来的に「どの時間帯でよくタスクをこなしているか」を分析できるように、
- 現時点では内部的に `timeSectionId` を保持するだけに留め、UIへの露出はタスク一覧のバッジとソートに限定。
- 必要ならコメントで TODO として「セクション別統計への拡張」を記載。

### 実装TODO（高レベル）

- `model-types` : `TimeSection*` 型と `Task.timeSectionId` の追加。
- `persist-settings` : `TimeSectionSettings` の読み書き関数とバリデーション。
- `time-utils` : 時間セクション判定ユーティリティの実装。
- `settings-ui` : 設定画面に曜日別セクション編集UIを追加。
- `task-form` : タスク編集フォームにセクション選択・自動判定表示を追加。
- `task-list-ui` : 並び替えオプションとセクションバッジ表示の追加。