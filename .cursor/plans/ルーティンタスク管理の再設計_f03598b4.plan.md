---
name: ルーティンタスク管理の再設計
overview: 現在の実装では繰り返しタスクが毎日別々のタスクインスタンスとして生成され、理想と乖離しています。ルーティンタスクをテンプレートとして1つだけ保持し、日々の実行状況を記録する方式に変更します。昨日できなかったタスクについては、ユーザーが反省して再作成・削除・変更できるようにします。
todos:
  - id: update-reflection-button
    content: DailyReflectionコンポーネントの生成ボタンを常に表示するように変更
    status: completed
---

# ルーティンタスク管理の再設計

## 問題の整理

### 現在の実装の問題点

1. **繰り返しタスクが別タスクとして表示される**

   - 毎日新しいタスクインスタンスを生成（`generateTodayRepeatTask`）
   - 同じルーティンタスク（例：「風呂」「夕食」）が毎日別々のタスクとして蓄積
   - タスクリストに「風呂」「風呂」「風呂」のように複数表示される

2. **昨日できなかったタスクの処理が自動的**

   - 朝5時に`skippedAt`を設定するが、その後自動的に今日のタスクが生成される
   - ユーザーが反省して「今日はやらない」「削除する」という選択ができない
   - 自動生成されるため、ユーザーの意思が反映されない

3. **ルーティンのトラッキングが分散**

   - HabitTrackerでグループ化して表示しているが、データは個別のタスクインスタンスとして保存
   - ルーティンの実行履歴を追跡するには、複数のタスクインスタンスを集計する必要がある

4. **空き時間の把握機能が不足**

   - ダッシュボードに時間分析機能はあるが、ルーティンがたまることで空き時間を把握する機能はない
   - ルーティンの完了率や時間の使い方の分析が不十分

### 理想との乖離

1. **毎日行動のログを取得する**

   - 現在：個別のタスクインスタンスとして保存
   - 理想：ルーティンとして統合的に管理し、日々の実行状況を記録

2. **ルーティンとしてトラッキング**

   - 現在：毎日新しいタスクを生成
   - 理想：ルーティンは1つのテンプレートとして管理し、日々の実行状況を記録

3. **空き時間の把握**

   - 現在：ルーティンの完了状況から空き時間を分析する機能がない
   - 理想：ルーティンがたまることで空き時間を把握し、時間の使い方を工夫するように仕向ける

4. **反省と改善**

   - 現在：昨日できなかったタスクは自動的に今日のタスクが生成される
   - 理想：昨日できなかったものは、反省をしたので今日新たに作成する、もしくは削除して切り替えがしたい

## 解決策の方向性

### アプローチ1: ルーティン実行記録を別データとして管理（推奨）

**概要：**

- ルーティンタスクは「テンプレート」として1つだけ保持
- 日々の実行状況は`RoutineExecution`という別のデータ構造で記録
- 朝5時に昨日の未完了タスクを検出し、ユーザーに選択肢を提示

**メリット：**

- データが整理され、ルーティンの実行履歴を追跡しやすい
- 空き時間の分析が容易
- ユーザーが反省して選択できる

**デメリット：**

- データ構造の変更が必要
- 既存のタスクデータとの互換性を保つ必要がある

### アプローチ2: 現在の構造を維持しつつ改善

**概要：**

- 現在のタスクインスタンス生成方式を維持
- 昨日できなかったタスクについては、朝5時に自動生成せず、ユーザーに選択肢を提示
- ルーティンの実行履歴は既存のタスクインスタンスから集計

**メリット：**

- 既存のデータ構造を維持できる
- 実装が比較的簡単

**デメリット：**

- タスクが蓄積し続ける問題は解決しない
- ルーティンの実行履歴の追跡が複雑

## 推奨実装：アプローチ1

### 1. データ構造の追加

**ファイル**: `src/types/index.ts`

```typescript
// ルーティン実行記録
export interface RoutineExecution {
  id: string
  routineTaskId: string // ルーティンタスク（テンプレート）のID
  date: string // ISO date string (実行日)
  completedAt?: string // ISO date string (完了時刻)
  skippedAt?: string // ISO date string (未完了として記録された時刻)
  elapsedTime?: number // 経過時間（秒）
  startTime?: string // ISO date string (開始時刻)
  endTime?: string // ISO date string (終了時刻)
  createdAt: string // ISO date string
  updatedAt: string // ISO date string
}
```

### 2. ルーティンタスクの管理方法の変更

**変更点：**

- 繰り返しタスクは「テンプレート」として1つだけ保持
- 日々の実行状況は`RoutineExecution`で記録
- `ensureTodayRepeatTasks`を削除し、代わりに`ensureTodayRoutineExecutions`を実装

### 3. 朝5時の処理の変更

**ファイル**: `src/services/taskService.ts`

- 昨日の未完了ルーティンを検出
- ユーザーに選択肢を提示するUIを表示
  - 「今日も実行する」
  - 「今日はスキップする」
  - 「このルーティンを削除する」
  - 「このルーティンを変更する」

### 4. タスクリストの表示ロジックの変更

**ファイル**: `src/components/tasks/TaskList.tsx`

- ルーティンタスクは「テンプレート」として表示
- 今日の実行状況は`RoutineExecution`から取得
- 完了/未完了の状態を表示

### 5. HabitTrackerの改善

**ファイル**: `src/components/dashboard/HabitTracker.tsx`

- `RoutineExecution`から実行履歴を取得
- ルーティンの完了率を表示
- 空き時間の分析に活用

### 6. ダッシュボードの改善

**ファイル**: `src/pages/Dashboard.tsx`

- ルーティンの完了率を表示
- 空き時間の分析を追加
- 時間の使い方の改善提案を表示

## 実装の詳細

### フェーズ1: データ構造の追加

1. `RoutineExecution`型を追加
2. `AppData`に`routineExecutions`フィールドを追加
3. サービス関数を追加（`getRoutineExecutions`, `addRoutineExecution`, `updateRoutineExecution`など）

### フェーズ2: ルーティンタスクの管理方法の変更

1. `ensureTodayRepeatTasks`を削除
2. `ensureTodayRoutineExecutions`を実装
3. ルーティンタスクのテンプレートを1つだけ保持するように変更

### フェーズ3: 朝5時の処理の変更

1. 昨日の未完了ルーティンを検出
2. ユーザーに選択肢を提示するUIを実装
3. ユーザーの選択に応じて処理を実行

### フェーズ4: UIの改善

1. タスクリストの表示ロジックを変更
2. HabitTrackerの改善
3. ダッシュボードの改善

## 注意事項

- 既存のタスクデータとの互換性を保つ必要がある
- 移行スクリプトが必要な場合がある
- ユーザーに変更内容を説明する必要がある